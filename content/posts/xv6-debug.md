---
title: "Xv6 Debug"
date: 2022-03-28T10:25:54+08:00
draft: false
---

## 1. 概要

## 2. 环境准备

## 3. 启动过程调试

xv6内核在qemu上的启动过程相对来说比较简单, xv6内核经过编译链接之后得到的是一个名为"kernel"的ELF文件. 启动qemu仿真器之后, "kernel"会被加载到物理内存的0x80000000地址处, RISC-V的每个hart都会从这个地址开始执行后续的指令. 注意此时hart处于M模式, 开始执行的"_entry"是使用RISC-V汇编编写而成, 主要作用是为执行后续的函数调用做准备, 程序能够完成函数调用, 需要使用"栈"保存函数的局部变量, 维护函数之间的调用关系连. 硬件提供了实现函数调用栈的机制, 每个RISC-V的hart都有一个sp寄存器, 即栈指针寄存器, sp保存了栈顶在内存中地址, "_entry"处的汇编代码为每个hart分别设置好了各自的sp寄存器, 内存中的栈空间是在start.c中预先分配的, "_entry"汇编代码会根据hart的id将sp指向栈空间的不同区域.

xv6在qemu上启动过程中会打印出log信息, 系统初始化完成之后运行第一个进程, 该进程会fork出一个子进程并运行user目录下的shell程序. 这个shell程序将作为用户使用xv6的接口, 比如可以使用ls命令查看当前目录下的内容, 接下来我们将通过gdb调试的方式研究从用户敲入ls命令到shell执行新进程的完整过程.

## 4. 参考文献